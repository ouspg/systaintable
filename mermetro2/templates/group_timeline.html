<!DOCTYPE html>
<html>
<head>
    <title>Mermetro2</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.9.3/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            maxTextSize: 10000000000,
            maxEdges: 500000,
            startOnLoad: true,
            flowchart: { htmlLabels: true, curve: 'linear' },
            securityLevel: 'loose'
        });
        let currentTimeline = '';
        let selectedGroup = '{{ selected_group }}';
        let chartDirection = 'TD';

        function createTable(entries, title, tooltipText, technicalClass = '') {
            let table = `
                <div class="entries-section">
                    <h4>${title} <span class="tooltip" title="${tooltipText}">â„¹</span></h4>
                    <div class="table-container">
                        <table class="entries-table${technicalClass ? ' ' + technicalClass : ''}">
                            <thead>
                                <tr>
                                    <th>Line</th>
                                    <th>Time</th>
                                    <th>Type</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            entries.forEach(entry => {
                table += `
                    <tr>
                        <td>${entry.line}</td>
                        <td>${entry.timestamp}</td>
                        <td>${entry.type}</td>
                        <td class="value-cell" title="${entry.value}">${entry.value}</td>
                    </tr>
                `;
            });
            table += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            return table;
        }

        window.showNodeDetails = function(nodeId) {
            const cleanNodeId = nodeId.startsWith('flowchart-') ? nodeId.substring(10) : nodeId;
            fetch(`/api/node-details/${cleanNodeId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Node "${cleanNodeId}" not found`);
                        return;
                    }
                    showNodeOrGroupModal(data);
                })
                .catch(error => {
                    alert(`Failed to fetch details: ${error.message}`);
                });
        }

        function showNodeOrGroupModal(nodeData) {
            let content = `
                <div class="node-info">
                    <p><strong>WIP</strong></p>
                </div>
            `;
            if (nodeData.entries && nodeData.entries.length > 0) {
                content += createTable(nodeData.entries, 'Personal Entries', 'Entries that contain personal information');
            }
            if (nodeData.technical_entries && nodeData.technical_entries.length > 0) {
                content += createTable(nodeData.technical_entries, 'Technical Entries', 'Technical entries found on the same lines', 'technical');
            }
            let title = (nodeData.type === 'Group') ? `Group Details: ${nodeData.value}` : `${nodeData.type}: ${nodeData.value}`;
            showModal(title, content);
        }

        function addClickEvents() {
            document.querySelectorAll('.node').forEach(element => {
                element.addEventListener('click', function() {
                    showNodeDetails(this.id);
                });
            });
        }

        function addGroupClickEvents() {
            document.querySelectorAll('.mermaid svg g[id]').forEach((element) => {
                if (element.id && element.id.startsWith('G')) {
                    element.classList.add('clickable-node');
                    element.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showNodeDetails(element.id);
                    });
                }
            });
            document.querySelectorAll('.mermaid svg .node').forEach((element) => {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    let parent = this.closest('[id]');
                    if (parent && parent.id) {
                        showNodeDetails(parent.id);
                    }
                });
            });
        }

        async function updateTimeline() {
            try {
                const response = await fetch('/api/timeline');
                const data = await response.json();
                if (data.timeline !== currentTimeline) {
                    currentTimeline = data.timeline;
                    selectedGroup = data.selected_group;
                    document.getElementById('formation-timeline-container').innerHTML = `
                        <div class="mermaid">${currentTimeline}</div>
                    `;
                    document.getElementById('selected-group').textContent = selectedGroup || 'None';
                    mermaid.init(undefined, document.querySelector('#formation-timeline-container .mermaid'));
                    setTimeout(function() {
                        addClickEvents();
                        addGroupClickEvents();
                    }, 1000);
                }
            } catch (error) {
                console.error('Error updating timeline:', error);
            }
        }

        function updateTimelineWithDirection() {
            fetch('/api/timeline')
                .then(response => response.json())
                .then(data => {
                    let timeline = data.timeline;
                    timeline = timeline.replace(/flowchart (TD|LR)/, `flowchart ${chartDirection}`);
                    document.getElementById('formation-timeline-container').innerHTML = `
                        <div class="mermaid">${timeline}</div>
                    `;
                    mermaid.init(undefined, document.querySelector('#formation-timeline-container .mermaid'));
                    setTimeout(function() {
                        addClickEvents();
                        addGroupClickEvents();
                    }, 1000);
                })
                .catch(error => {
                    console.error('Error updating timeline direction:', error);
                });
        }

        function selectGroup(groupId) {
            fetch(`/api/select-group/${groupId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentTimeline = data.timeline;
                        selectedGroup = data.selected_group;
                        document.getElementById('formation-timeline-container').innerHTML = `
                            <div class="mermaid">${currentTimeline}</div>
                        `;
                        document.getElementById('selected-group').textContent = selectedGroup;
                        chartDirection = 'TD';
                        const directionBtn = document.getElementById('direction-btn');
                        if (directionBtn) {
                            directionBtn.textContent = 'Top Down';
                        }
                        mermaid.init(undefined, document.querySelector('#formation-timeline-container .mermaid'));
                        setTimeout(function() {
                            addClickEvents();
                            addGroupClickEvents();
                        }, 1000);
                    } else {
                        alert('Error selecting group: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error selecting group:', error);
                    alert('Error selecting group: ' + error.message);
                });
        }

        async function loadGroups() {
            try {
                const response = await fetch('/api/groups');
                const groups = await response.json();
                const selector = document.getElementById('group-selector');
                selector.innerHTML = '<option value="">Select a group...</option>';
                Object.keys(groups).forEach(groupId => {
                    const group = groups[groupId];
                    const option = document.createElement('option');
                    option.value = groupId;
                    option.textContent = `${groupId} (${group.count} entries, ${group.nodes - 1} nodes)`;
                    if (groupId === selectedGroup) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
                selector.addEventListener('change', function() {
                    if (this.value) {
                        selectGroup(this.value);
                    }
                });
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        function showModal(title, content) {
            const modal = document.getElementById('nodeModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            modal.style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const directionBtn = document.getElementById('direction-btn');
            directionBtn.addEventListener('click', function() {
                chartDirection = (chartDirection === 'TD') ? 'LR' : 'TD';
                directionBtn.textContent = (chartDirection === 'TD') ? 'Top Down' : 'Left Right';
                updateTimelineWithDirection();
            });
            const modal = document.getElementById('nodeModal');
            const groupLogModal = document.getElementById('groupLogModal');
            document.querySelector('#nodeModal .close').addEventListener('click', function() {
                modal.style.display = 'none';
            });
            document.querySelector('#groupLogModal .close').addEventListener('click', function() {
                groupLogModal.style.display = 'none';
            });
            window.addEventListener('click', function(event) {
                if (event.target === modal) modal.style.display = 'none';
                if (event.target === groupLogModal) groupLogModal.style.display = 'none';
            });
            loadGroups();
            if (selectedGroup) {
                updateTimeline();
            }
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length && document.querySelector('.mermaid svg')) {
                        addClickEvents();
                        addGroupClickEvents();
                        observer.disconnect();
                    }
                });
            });
            observer.observe(document.querySelector('.mermaid'), { childList: true, subtree: true });
            setTimeout(function() {
                addClickEvents();
                addGroupClickEvents();
            }, 2000);
        });

        setInterval(updateTimeline, 10000);

    </script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5; 
        }
        .header {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status { 
            color: #4CAF50; 
            font-weight: bold; 
        }
        .mermaid { 
            text-align: center; 
            background-color: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 400px;
        }
        h1 { 
            color: #333; 
            text-align: center; 
            margin: 0 0 20px 0;
        }
        .controls {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .control-group {
            margin-bottom: 10px;
        }
        .control-group label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        #group-selector {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 300px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: none;
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        .entries-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .entries-table th,
        .entries-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .entries-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .entries-table.technical th {
            background-color: #fff3e0;
        }
        .entries-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .value-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .entries-section {
            margin-bottom: 20px;
        }
        .node-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .node-info p {
            margin: 5px 0;
        }
        .merge-log {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
        }
        .merge-entry {
            background-color: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            border-left: 3px solid #f39c12;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .tooltip {
            cursor: help;
            color: #666;
        }
        .node {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .node:hover {
            opacity: 0.8;
        }
        #direction-btn {
            padding: 6px 18px;
            font-size: 15px;
            border: 1px solid #2196f3;
            background: #fff;
            color: #2196f3;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
        }
        #direction-btn:hover {
            background: #e3f2fd;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Mermetro2</h1>
    </div>
    <div class="controls">
        <div class="control-group">
            <label for="group-selector">Select Group:</label>
            <select id="group-selector"></select>
        </div>
        <div class="control-group">
            <label>Selected:</label>
            <span id="selected-group" class="status">{{ selected_group or 'None' }}</span>
        </div>
        <div class="control-group">
            <label>Last Update:</label>
            <span class="status">{{ timestamp }}</span>
        </div>
    </div>
    <div class="diagram-section">
        <div class="section-header">
            <h2>Group Formation Timeline</h2>
            <div class="control-group">
                <label for="direction-btn" style="margin-right:10px;">Swap Direction</label>
                <button id="direction-btn" type="button">Top Down</button>
            </div>
        </div>
        <div class="diagram-container" id="formation-timeline-container">
            {% if timeline %}
            <div class="mermaid">{{ timeline|safe }}</div>
            {% else %}
            <div class="mermaid"></div>
            {% endif %}
        </div>
    </div>
    <div id="nodeModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Details</h2>
            <div id="modalContent"></div>
        </div>
    </div>
    <div id="groupLogModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('groupLogModal').style.display='none'">&times;</span>
            <h2 id="groupLogModalTitle">Group Formation Log</h2>
            <div id="groupLogModalContent"></div>
        </div>
    </div>
</body>
</html>
